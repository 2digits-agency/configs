# Plan: OpenCode Plugin for Shared Agent Rules & Feedback System

## Overview

Build an OpenCode plugin that:

1. **Auto-injects** shared team rules into every conversation
2. **Provides `/fix` command** to submit feedback → creates GitHub issue in `2digits-agency/configs`
3. **Enables curation** of shared AGENTS.md rules via GitHub issues/PRs

## Architecture

```
configs-2digits/
├── packages/
│   └── opencode-plugin/          # NEW: publishable plugin package
│       ├── src/
│       │   ├── index.ts          # Plugin entry (includes tool + issue creation)
│       │   └── rules.ts          # Bundled rules loader
│       ├── rules/                # Curated rule sets (bundled as text)
│       │   ├── base.md           # Core rules (type safety, etc.)
│       │   ├── effect.md         # Effect-specific patterns
│       │   └── react.md          # React/Next.js patterns
│       ├── package.json
│       └── tsconfig.json
└── .opencode/
    └── command/
        └── fix.md                # /fix slash command definition
```

## Implementation Details

### 1. Plugin Package (`@2digits/opencode-plugin`)

**Entry Point** (`src/index.ts`):

```typescript
import { tool, type Hooks, type Plugin } from '@opencode-ai/plugin';

import { loadRules } from './rules';

const plugin: Plugin = async (ctx): Promise<Hooks> => ({
  // Inject shared rules into system prompt
  'experimental.chat.system.transform': async (_input, output) => {
    const rules = await loadRules();
    output.system.push(`Instructions from: @2digits/opencode-plugin\n${rules}`);
  },

  // Tool for creating feedback issues
  tool: {
    create_feedback_issue: tool({
      description: 'Create GitHub issue in 2digits-agency/configs with agent feedback',
      args: {
        title: tool.schema.string().describe('Concise issue title'),
        feedback: tool.schema.string().describe('Detailed feedback about what went wrong'),
        context: tool.schema.string().optional().describe('Relevant conversation context'),
        suggestedRule: tool.schema.string().optional().describe('Proposed rule to add'),
      },
      async execute(args) {
        const body = formatIssueBody(args);
        // Use gh CLI (already authenticated via user's gh auth)
        const result = await ctx.$`gh issue create \
          --repo 2digits-agency/configs \
          --title ${`[Agent Feedback] ${args.title}`} \
          --body ${body} \
          --label agent-feedback`.text();

        return `Created issue: ${result.trim()}`;
      },
    }),
  },
});

function formatIssueBody(args: { feedback: string; context?: string; suggestedRule?: string }): string {
  const sections = [
    '## Feedback',
    args.feedback,
    args.context ? `\n## Context\n\`\`\`\n${args.context}\n\`\`\`` : '',
    args.suggestedRule ? `\n## Suggested Rule\n${args.suggestedRule}` : '',
    '\n---\n_Created via `/fix` command in OpenCode_',
  ];
  return sections.filter(Boolean).join('\n');
}

export default plugin;
```

**Rules Loader** (`src/rules.ts`):

```typescript
// Import bundled markdown files as text (using Bun's text loader)
import baseRules from '../rules/base.md' with { type: 'text' };
import effectRules from '../rules/effect.md' with { type: 'text' };
import reactRules from '../rules/react.md' with { type: 'text' };

export function loadRules(): string {
  return [baseRules, effectRules, reactRules].join('\n\n');
}
```

### 2. `/fix` Slash Command (`.opencode/command/fix.md`)

```markdown
---
description: Submit feedback about agent behavior to improve shared rules
subtask: true
---

Submit feedback about something the agent did wrong or could improve.

## Instructions

1. Ask clarifying questions to understand:
   - What specifically went wrong?
   - What should have happened instead?
   - Is this a recurring pattern or one-off?

2. Use the `create_feedback_issue` tool with:
   - **title**: Concise description of the issue
   - **feedback**: Detailed explanation of what went wrong
   - **context**: Relevant code/conversation snippets
   - **suggestedRule**: If obvious, propose a rule to prevent this

3. Return the issue URL so user can track/discuss

## User Input

<Feedback>
  $ARGUMENTS
</Feedback>
```

### 3. Rules Structure

**Base Rules** (`rules/base.md`):

```markdown
## Code Quality Standards

- Make minimal, surgical changes
- Never compromise type safety: No any, no !, no as Type
- Make illegal states unrepresentable: ADTs, parse at boundaries
- Abstractions: Consciously constrained, pragmatically parameterised

## Patterns to Avoid

- Premature optimization
- Magic strings/numbers without constants
- Nested ternaries beyond 2 levels
```

**Effect Rules** (`rules/effect.md`):

```markdown
## Effect Patterns

- Use Effect.gen for readable sequential composition
- Define tagged errors with Schema.TaggedError
- Services use Context.Tag class pattern
- Always use Effect.fn for traceable service methods
```

### 4. Distribution Options

**Option A: NPM Package (Recommended)**

```json
// opencode.json in any project
{
  "plugin": ["@2digits/opencode-plugin"]
}
```

**Option B: File URL**

```json
{
  "plugin": ["file:///path/to/@2digits/opencode-plugin/dist/index.js"]
}
```

**Option C: Local Development**

```
.opencode/
└── plugins/
    └── 2digits.ts  # Symlink or copy
```

## Workflow for Curating Rules

```
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  User uses /fix │────▶│  GitHub Issue    │────▶│  Team reviews   │
│  in OpenCode    │     │  created         │     │  & discusses    │
└─────────────────┘     └──────────────────┘     └────────┬────────┘
                                                          │
                                                          ▼
┌─────────────────┐     ┌──────────────────┐     ┌─────────────────┐
│  New rule in    │◀────│  PR merged       │◀────│  Propose rule   │
│  plugin release │     │  + changeset     │     │  change in PR   │
└─────────────────┘     └──────────────────┘     └─────────────────┘
```

## Tasks

### Phase 1: Package Setup

- [ ] Create `packages/opencode-plugin` directory structure
- [ ] Add package.json with `@2digits/opencode-plugin` name
- [ ] Configure tsconfig.json extending `@2digits/tsconfig`
- [ ] Add to pnpm-workspace.yaml and turbo.json

### Phase 2: Core Implementation

- [ ] Implement plugin entry point with hooks registration
- [ ] Implement rules loader (bundled markdown files)
- [ ] Implement issue creation using `gh` CLI via ctx.$
- [ ] Add error handling for gh command failures

### Phase 3: Rules Content

- [ ] Extract/consolidate existing rules from global/project AGENTS.md
- [ ] Create base.md with core quality standards
- [ ] Create technology-specific rule files (effect.md, react.md)

### Phase 4: Slash Command

- [ ] Create `.opencode/command/fix.md` with structured prompt
- [ ] Define issue body template with good formatting

### Phase 5: Testing & Documentation

- [ ] Test plugin locally with file:// URL
- [ ] Document installation in configs README
- [ ] Create changeset for initial release

## Open Questions

~~All resolved via user input:~~

- ~~Effect vs plain~~ → Using `gh` CLI (already authenticated)
- ~~Rules source~~ → Bundled in package
- ~~Location~~ → This repo (`packages/opencode-plugin`)

## Verification

1. Install plugin locally: `opencode.json` with `file://` path
2. Start OpenCode, verify rules appear in system prompt
3. Run `/fix something went wrong` → verify issue created
4. Check issue has proper formatting, labels, context

## Files to Create/Modify

| File                                     | Action | Purpose            |
| ---------------------------------------- | ------ | ------------------ |
| `packages/opencode-plugin/package.json`  | Create | Package definition |
| `packages/opencode-plugin/tsconfig.json` | Create | TypeScript config  |
| `packages/opencode-plugin/src/index.ts`  | Create | Plugin entry       |
| `packages/opencode-plugin/src/rules.ts`  | Create | Rules loader       |
| `packages/opencode-plugin/rules/base.md` | Create | Base rules         |
| `.opencode/command/fix.md`               | Create | Slash command      |
| `pnpm-workspace.yaml`                    | Modify | Add package        |
| `turbo.json`                             | Modify | Add build task     |
